---
tags:
  - k3s
  - howto
  - ha
  - debian
created: 2025-01-15
updated: 2026-01-19
---

# K3s — Установка HA кластера

Пошаговая инструкция по развёртыванию [[K3s]] HA кластера на [[Debian]] 13.

## Теория: Что такое HA кластер?

**HA (High Availability)** — архитектура, обеспечивающая отказоустойчивость. Если одна нода падает, кластер продолжает работать.

### Компоненты K3s HA

```
┌─────────────────────────────────────────────────────────────┐
│                    Control Plane (Server)                    │
├─────────────────────────────────────────────────────────────┤
│  API Server    │  Точка входа для всех запросов (kubectl)   │
│  Scheduler     │  Решает, на какой ноде запустить под       │
│  Controller    │  Следит за желаемым состоянием кластера    │
│  etcd          │  Распределённая БД состояния кластера      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Data Plane (Agent)                        │
├─────────────────────────────────────────────────────────────┤
│  kubelet       │  Запускает контейнеры на ноде              │
│  kube-proxy    │  Сетевые правила для Services              │
│  containerd    │  Container runtime (замена Docker)         │
└─────────────────────────────────────────────────────────────┘
```

### Почему 3 ноды?

**etcd** использует алгоритм консенсуса Raft, требующий **кворум** (большинство):

| Нод | Кворум | Допустимо падений |
|-----|--------|-------------------|
| 1   | 1      | 0                 |
| 2   | 2      | 0 (!)             |
| 3   | 2      | 1                 |
| 5   | 3      | 2                 |

> **Важно:** 2 ноды хуже чем 1 — при падении любой кворум теряется.

---

## Подготовка системы

### Базовые утилиты

```bash
sudo apt install vim htop btop mc curl wget -y
```

| Утилита | Назначение |
|---------|------------|
| `vim` | Текстовый редактор |
| `htop` | Интерактивный мониторинг процессов |
| `btop` | Современный мониторинг ресурсов |
| `mc` | Midnight Commander — файловый менеджер |
| `curl` | HTTP клиент (нужен для установки K3s) |
| `wget` | Загрузка файлов |

**Флаг `-y`** — автоматическое "yes" на все вопросы (non-interactive mode).

### Настройка sudo

```bash
su -
apt update && apt install sudo
/usr/sbin/usermod -aG sudo nodeadm
```

**Разбор команд:**

| Команда | Объяснение |
|---------|------------|
| `su -` | Переключиться на root. Дефис загружает окружение root |
| `apt update` | Обновить список пакетов из репозиториев |
| `&&` | Выполнить следующую команду только если предыдущая успешна |
| `usermod` | Модификация пользователя |
| `-a` | Append — добавить к существующим группам (без этого заменит!) |
| `-G sudo` | Добавить в группу sudo |

> **Важно:** На минимальных Debian `/usr/sbin/` не в PATH — используй полный путь.

### Статические IP

> **Критично:** Для HA с etcd нужны статические IP. etcd хранит адреса членов кластера — при смене IP нода "потеряется".

Редактируем `/etc/network/interfaces`:

```
auto enp1s0
iface enp1s0 inet static
    address 192.168.20.221
    netmask 255.255.255.0
    gateway 192.168.20.254
    dns-nameservers 1.1.1.3 1.0.0.3
```

**Разбор конфигурации:**

| Директива | Значение |
|-----------|----------|
| `auto enp1s0` | Поднимать интерфейс автоматически при загрузке |
| `iface ... inet static` | Использовать статический IPv4 (не DHCP) |
| `address` | IP адрес этой машины |
| `netmask` | Маска подсети (255.255.255.0 = /24 = 254 хоста) |
| `gateway` | IP роутера для выхода за пределы подсети |
| `dns-nameservers` | DNS серверы (1.1.1.3 = Cloudflare Family) |

```bash
sudo systemctl restart networking
```

**systemctl** — управление systemd сервисами:
- `restart` — остановить и запустить заново
- `start` / `stop` — запустить / остановить
- `enable` / `disable` — включить/выключить автозапуск
- `status` — показать состояние

### Установка зависимостей

На **всех нодах**:

```bash
sudo apt update && sudo apt install -y iptables curl
```

| Пакет | Зачем нужен |
|-------|-------------|
| `iptables` | Firewall. K3s использует для сетевых правил (kube-proxy) |
| `curl` | Для скачивания установочного скрипта K3s |

---

## Теория: Как работает установка K3s

Установочный скрипт `https://get.k3s.io`:

1. Определяет архитектуру (amd64, arm64)
2. Скачивает бинарник K3s
3. Создаёт systemd unit файл
4. Запускает K3s как сервис

**Переменные окружения** передаются скрипту и влияют на установку:

| Переменная | Назначение |
|------------|------------|
| `K3S_TOKEN` | Shared secret для авторизации нод |
| `K3S_URL` | URL API server (для agent нод) |
| `INSTALL_K3S_EXEC` | Аргументы для K3s |
| `INSTALL_K3S_VERSION` | Конкретная версия |
| `INSTALL_K3S_SKIP_START` | Не запускать после установки |

---

## Установка кластера

### Node 1 — инициализация

#### Генерация токена

```bash
openssl rand -base64 32
```

**Разбор:**
- `openssl` — криптографическая утилита
- `rand` — генерация случайных данных
- `-base64` — кодировать в Base64 (только печатаемые символы)
- `32` — 32 байта = 256 бит энтропии

> Токен должен быть **одинаковым** на всех нодах. Сохрани его!

#### Установка первой ноды

```bash
curl -sfL https://get.k3s.io | K3S_TOKEN=<YOUR_TOKEN> sh -s - server \
    --cluster-init \
    --tls-san 192.168.20.225 \
    --disable servicelb \
    --write-kubeconfig-mode 644
```

**Разбор curl:**

| Флаг | Значение |
|------|----------|
| `-s` | Silent — не показывать прогресс |
| `-f` | Fail — вернуть ошибку при HTTP 4xx/5xx |
| `-L` | Follow redirects — следовать перенаправлениям |

**Разбор pipe:**
- `|` — pipe, передаёт stdout curl в stdin sh
- `sh -s -` — запустить shell, читать скрипт из stdin
- Всё после `-` передаётся как аргументы скрипту

**Разбор аргументов K3s:**

| Аргумент | Объяснение |
|----------|------------|
| `server` | Запустить как server (control plane + agent) |
| `--cluster-init` | Инициализировать новый HA кластер с embedded etcd |
| `--tls-san 192.168.20.225` | Добавить VIP в SAN сертификата API server |
| `--disable servicelb` | Отключить встроенный LoadBalancer (ServiceLB/Klipper) |
| `--write-kubeconfig-mode 644` | Права на kubeconfig (читаемый всеми) |

**Подробнее о флагах:**

**`--cluster-init`**
Без этого флага K3s использует SQLite (однонодовый режим). С флагом — embedded etcd для HA.

**`--tls-san` (Subject Alternative Name)**
TLS сертификат API server содержит список разрешённых имён/IP. Клиент проверяет, что подключается к правильному серверу. VIP должен быть в этом списке, иначе kubectl откажется подключаться.

**`--disable servicelb`**
K3s включает ServiceLB (Klipper) — простой LoadBalancer для bare-metal. Мы используем [[K3s - kube-vip|kube-vip]] вместо него.

**`--write-kubeconfig-mode 644`**
По умолчанию kubeconfig доступен только root (600). С 644 его могут читать все пользователи.

### Настройка kube-vip

См. [[K3s - kube-vip]]

### Node 2 и Node 3

```bash
curl -sfL https://get.k3s.io | K3S_TOKEN=<YOUR_TOKEN> sh -s - server \
    --server https://192.168.20.225:6443 \
    --tls-san 192.168.20.225 \
    --disable servicelb \
    --write-kubeconfig-mode 644
```

**Отличия от Node 1:**

| Аспект | Node 1 | Node 2/3 |
|--------|--------|----------|
| `--cluster-init` | Да | Нет |
| `--server` | Нет | Да (URL существующего кластера) |

**`--server https://192.168.20.225:6443`**
Указывает URL для присоединения к существующему кластеру. Используем VIP, не IP первой ноды — так при падении Node 1 новые ноды всё равно смогут присоединиться.

**Порт 6443** — стандартный порт Kubernetes API server.

---

## Проверка

```bash
# Все ноды Ready
kubectl get nodes
```

**kubectl get** — получить список ресурсов.
- `nodes` — тип ресурса (ноды кластера)
- Статус `Ready` = нода работает и принимает поды

```bash
# Системные поды Running
kubectl get pods -n kube-system
```

| Флаг | Значение |
|------|----------|
| `-n kube-system` | Namespace. Системные компоненты живут в `kube-system` |

**Namespaces** — логическое разделение ресурсов в кластере:
- `default` — для пользовательских приложений
- `kube-system` — системные компоненты
- `kube-public` — публичные ресурсы (редко используется)

```bash
# kube-vip на каждой ноде
kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-vip-ds
```

| Флаг | Значение |
|------|----------|
| `-l` | Label selector — фильтр по меткам |

**Labels** — key-value метки на ресурсах для организации и выборки.

**Тест отказоустойчивости:**
```bash
sudo reboot  # на любой ноде
# С другой ноды кластер должен работать
kubectl get nodes
```

При падении одной ноды кворум сохраняется (2 из 3), кластер продолжает работать.

---

## Добавление worker нод

Worker (agent) ноды только выполняют workloads, не участвуют в control plane.

```bash
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.20.225:6443 \
    K3S_TOKEN=<YOUR_TOKEN> sh -
```

**Отличия от server:**
- `K3S_URL` вместо `--server` — для agent переменная окружения
- Нет `server` в аргументах — по умолчанию запускается agent
- Agent не запускает etcd, API server и т.д.

### Labels (метки)

```bash
kubectl label nodes <gpu-node> node-type=gpu
kubectl label nodes <jetson-node> node-type=edge-ai
```

**kubectl label** — добавить/изменить метку на ресурсе.

**Синтаксис:** `kubectl label <resource-type> <name> <key>=<value>`

Labels используются для:
- **nodeSelector** — запускать поды только на определённых нодах
- **Организации** — группировка ресурсов
- **Service discovery** — выборка подов для Service

```yaml
# Пример использования в Pod
spec:
  nodeSelector:
    node-type: gpu
```

---

## Удаление K3s

```bash
# Server
/usr/local/bin/k3s-uninstall.sh

# Agent
/usr/local/bin/k3s-agent-uninstall.sh
```

Скрипты удаления:
1. Останавливают сервис
2. Удаляют бинарники и конфиги
3. Очищают iptables правила
4. Удаляют данные (`/var/lib/rancher/k3s`)

> **Внимание:** На server с etcd это удалит данные кластера на этой ноде!

---

## Полезные команды диагностики

```bash
# Логи K3s в реальном времени
journalctl -u k3s -f

# Статус сервиса
systemctl status k3s

# Версия K3s
k3s --version

# Информация о кластере
kubectl cluster-info

# Подробная информация о ноде
kubectl describe node <name>
```

| Команда | Объяснение |
|---------|------------|
| `journalctl -u k3s` | Логи systemd unit `k3s` |
| `-f` | Follow — показывать новые записи в реальном времени |
| `describe` | Подробная информация о ресурсе (события, условия) |

## См. также

- [[K3s]]
- [[K3s - Архитектура]]
- [[K3s - kube-vip]]
- [[K3s - GPU Support]]
- [[K3s - Troubleshooting]]
- [[Kubernetes]]
