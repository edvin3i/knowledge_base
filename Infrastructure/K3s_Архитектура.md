---
tags:
  - k3s
  - architecture
  - homelab
created: 2025-01-15
updated: 2026-01-24
---

# K3s — Архитектура кластера

Схема моего HA кластера [[K3s]].

## Топология

```
                    ┌─────────────────────────────┐
                    │      Virtual IP (VIP)       │
                    │      192.168.20.225         │
                    │    управляется kube-vip     │
                    └─────────────┬───────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   polynode-1  │       │   polynode-2  │       │   polynode-3  │
│192.168.20.221 │       │192.168.20.222 │       │192.168.20.223 │
│───────────────│       │───────────────│       │───────────────│
│ K3s Server    │◄─────►│ K3s Server    │◄─────►│ K3s Server    │
│ + Agent       │ etcd  │ + Agent       │ etcd  │ + Agent       │
│ + etcd        │ sync  │ + etcd        │ sync  │ + etcd        │
│ + kube-vip    │       │ + kube-vip    │       │ + kube-vip    │
└───────────────┘       └───────────────┘       └───────────────┘
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │      polydev-desktop        │
                    │      192.168.20.16          │
                    │─────────────────────────────│
                    │  K3s Agent (GPU Worker)     │
                    │  NVIDIA RTX A6000 (48GB)    │
                    │  24 CPU | 64GB RAM          │
                    └─────────────────────────────┘
```

### Control Plane (Servers)

**Железо:** [[Dell OptiPlex 3050]] | Intel Core i5-7500T | RAM 8GB | SSD 256GB

### GPU Worker

**Железо:** [[polydev-desktop]] | 24 CPU cores | RAM 64GB | NVIDIA RTX A6000 48GB

## Компоненты

| Компонент | Описание |
|-----------|----------|
| **K3s Server** | Control plane: API Server, Controller Manager, Scheduler |
| **K3s Agent** | Worker: kubelet, kube-proxy |
| **Embedded etcd** | Распределённая БД состояния (кворум 2 из 3) |
| **[[K3s - kube-vip\|kube-vip]]** | Virtual IP для отказоустойчивого доступа к API |
| **[[Longhorn]]** | Distributed block storage (replicated across nodes) |
| **Flannel** | CNI plugin (VXLAN overlay network) |
| **Traefik** | Ingress controller (built-in) |

## Сети

| Сеть | CIDR | Назначение |
|------|------|------------|
| **Физическая** | `192.168.20.0/24` | LAN, ноды кластера |
| **Pod Network** | `10.42.0.0/16` | IP адреса подов (Flannel) |
| **Service Network** | `10.43.0.0/16` | ClusterIP сервисов |

## Требуемые порты

| Порт | Протокол | Назначение |
|------|----------|------------|
| 6443 | TCP | Kubernetes API server |
| 2379 | TCP | etcd client |
| 2380 | TCP | etcd peer |
| 10250 | TCP | Kubelet metrics |
| 8472 | UDP | Flannel VXLAN |

## Планируемое расширение

- [x] GPU нода (RTX A6000) — [[polydev-desktop]]
- [ ] Edge нода (Jetson Nano)

```
                                  │
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
      ┌─────────────────────────┐     ┌───────────────┐
      │    polydev-desktop      │     │  Jetson Nano  │
      │      RTX A6000          │     │  Agent only   │
      │      ГОТОВО             │     │  label: edge  │
      └─────────────────────────┘     └───────────────┘
```

---

## Взаимодействие сервисов

Схема взаимодействия развёрнутых приложений:

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          СЕРВИСЫ И ИХ ВЗАИМОДЕЙСТВИЕ                          │
│                                                                               │
│  Внешние клиенты (браузер, агенты, SDK)                                      │
│         │                                                                     │
│         │  HTTP через LoadBalancer IP (MetalLB)                              │
│         ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        MetalLB IP Pool                                   │ │
│  │                      192.168.20.235 - 245                                │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                     │
│    ┌────┴────┬──────────┬──────────┬──────────┬──────────┐                  │
│    ▼         ▼          ▼          ▼          ▼          ▼                  │
│  .235     .236       .237       .238       .240-.242   .239                 │
│ Traefik  Nuclio     MinIO      MinIO      ClearML    Longhorn               │
│          Dashboard   API       Console    Web/API/FS   UI                   │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                    │
     ┌──────────────────────────────┼──────────────────────────────┐
     │                              │                              │
     ▼                              ▼                              ▼

┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│ namespace: cvat │      │ namespace: minio│      │namespace:clearml│
├─────────────────┤      ├─────────────────┤      ├─────────────────┤
│                 │      │                 │      │                 │
│ ┌─────────────┐ │      │ ┌─────────────┐ │      │ ┌─────────────┐ │
│ │  frontend   │ │      │ │   minio-0   │ │      │ │  webserver  │ │
│ └──────┬──────┘ │      │ │   (9000)    │ │      │ └─────────────┘ │
│        │        │      │ └─────────────┘ │      │ ┌─────────────┐ │
│        ▼        │      │                 │      │ │  apiserver  │ │
│ ┌─────────────┐ │      └─────────────────┘      │ │   (8008)    │ │
│ │   backend   │─┼────────────────────────────────│ └─────────────┘ │
│ │   server    │ │    S3 API для артефактов      │ ┌─────────────┐ │
│ └──────┬──────┘ │                               │ │  fileserver │ │
│        │        │                               │ │   (8081)    │ │
│   ┌────┴────┐   │                               │ └─────────────┘ │
│   ▼         ▼   │                               │                 │
│ ┌─────┐ ┌─────┐ │                               │ ┌─────────────┐ │
│ │Redis│ │ PG  │ │                               │ │  MongoDB    │ │
│ └─────┘ └─────┘ │                               │ │  Redis      │ │
│                 │                               │ │  Elastic    │ │
│ ┌─────────────┐ │                               │ └─────────────┘ │
│ │   Nuclio    │ │                               │                 │
│ │  Dashboard ─┼─┼───────────────────────────────┼───► S3 bucket  │
│ │  Controller │ │                               │     "clearml"  │
│ └──────┬──────┘ │                               │                 │
│        │ HTTP   │                               └─────────────────┘
│        ▼        │
│ ┌─────────────┐ │
│ │  Function   │ │
│ │  YOLO11     │─┼──────► GPU Node (polydev-desktop)
│ │  (8080)     │ │
│ └─────────────┘ │
│                 │
└─────────────────┘
```

### Потоки данных

| Откуда | Куда | Протокол | Назначение |
|--------|------|----------|------------|
| CVAT Backend | MinIO | S3 (HTTP) | Хранение изображений/видео |
| CVAT Backend | PostgreSQL | TCP 5432 | Метаданные, пользователи |
| CVAT Backend | Redis | TCP 6379 | Очереди задач |
| CVAT Backend | Nuclio Dashboard | HTTP 80 | Получение списка моделей |
| Nuclio Dashboard | Nuclio Function | HTTP 8080 | Инференс (автоаннотация) |
| ClearML SDK | ClearML API Server | HTTP 80 | Логирование экспериментов |
| ClearML Agent | ClearML API Server | HTTP 80 | Получение задач |
| ClearML | MinIO | S3 (HTTP) | Хранение артефактов |

### Cross-namespace коммуникация

```
┌───────────────────────────────────────────────────────────────────────────┐
│                     DNS-BASED SERVICE DISCOVERY                            │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│   CVAT (namespace: cvat) хочет обратиться к MinIO (namespace: minio):     │
│                                                                            │
│   Вариант 1: Через LoadBalancer IP                                        │
│   ────────────────────────────────                                        │
│   AWS_S3_ENDPOINT_URL=http://192.168.20.237                               │
│   ✓ Работает и изнутри кластера, и снаружи                                │
│   ✗ Зависит от внешнего IP                                                │
│                                                                            │
│   Вариант 2: Через внутренний DNS                                         │
│   ────────────────────────────────                                        │
│   AWS_S3_ENDPOINT_URL=http://minio.minio.svc.cluster.local:80             │
│   или короче: http://minio.minio:80                                       │
│   ✓ Не зависит от внешнего IP                                             │
│   ✓ Быстрее (трафик внутри кластера)                                      │
│   ✗ Работает только изнутри кластера                                      │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
```

### Пример: путь запроса автоаннотации

```
┌──────────────────────────────────────────────────────────────────────────────┐
│  Пользователь нажимает "Auto-annotate" в CVAT UI                            │
│                                                                              │
│  1. Browser ──HTTP POST──► CVAT Frontend (192.168.20.235)                   │
│                             │                                                │
│  2. Frontend ──► CVAT Backend Server                                        │
│                             │                                                │
│  3. Backend ──► Redis (создаёт задачу в очереди)                            │
│                             │                                                │
│  4. Worker-Annotation ◄── Redis (получает задачу)                           │
│                             │                                                │
│  5. Worker ──HTTP GET──► Nuclio Dashboard (cvat-nuclio-dashboard:80)        │
│     "Дай мне список функций"                                                │
│                             │                                                │
│  6. Dashboard ──HTTP POST──► Nuclio Function Service                        │
│     (nuclio-yolo11x-cvat-detector-gpu.cvat.svc.cluster.local:8080)          │
│     "Вот изображение, верни bbox'ы"                                         │
│                             │                                                │
│  7. Function Pod (на GPU ноде) выполняет инференс                           │
│                             │                                                │
│  8. Результат возвращается: Function → Dashboard → Worker → Backend → UI   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## См. также

- [[Kubernetes - Сеть и взаимодействие]] — теория networking
- [[K3s]]
- [[K3s - Установка HA]]
- [[K3s - GPU Support]]
- [[K3s - kube-vip]]
- [[Longhorn]]
- [[Services]]
- [[MetalLB]]
